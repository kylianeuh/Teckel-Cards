<!DOCTYPE html>
<html lang="fr" class="font-grotesque bg-mint-green-100">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Darker+Grotesque:wght@300..900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/css/output.css" />
    <link rel="stylesheet" href="/style-cards.css" />
</head>

<body>
    <%- include('partials/header') %>
        <main class="min-h-screen bg-gray-50 px-2 py-3 ">
            <div class="button-principal">
                <div><a href="/" class="text-sm">Accueil</a></div>
              </div>
            <h1 class="text-3xl font-bold text-center mb-2">üé¥ Ma collection</h1>
            <div class="border rounded shadow-2xl border-gray-300 p-2 m-2 mb-8 w-30">
                <div class="flex flex-col">
                    <h2 class="text-lg font-bold text-gray-800">Mes cartes</h2>
                    <ul class="text-sm mt-2 space-y-1">
                        <li class="flex justify-between items-center"><div class="w-7 bg-gray-500 text-white rounded text-[10px] font-bold px-2 py-0.5 shadow mr-1">T0</div> <%= statsTier.T0 %> / 100</li>
                        <li class="flex justify-between items-center"><div class="w-7 bg-gradient-to-br from-blue-400 to-violet-500 text-white rounded text-[10px] font-bold px-2 py-0.5 shadow mr-1">T1</div> <%= statsTier.T1 %> / 100</li>
                        <li class="flex justify-between items-center"><div class="w-7 bg-gradient-to-br from-violet-400 to-red-500 text-white rounded text-[10px] font-bold px-2 py-0.5 shadow mr-1">T2</div> <%= statsTier.T2 %> / 100</li>
                        <li class="flex justify-between items-center"><div class="w-7 bg-gradient-to-br from-gray-300 to-gray-600 text-white rounded text-[10px] font-bold px-2 py-0.5 shadow mr-1">T3</div> <%= statsTier.T3 %> / 100</li>
                        <li class="flex justify-between items-center"><div class="w-7 bg-gradient-to-br from-yellow-200 to-yellow-400 text-black rounded text-[10px] font-bold px-2 py-0.5 shadow mr-1">T4</div> <%= statsTier.T4 %> / 100</li>
                      </ul>
                </div>
            </div>
            <% const gradientMap={ 
                1: "from-[#e8d8c3] to-[#dab892] border-yellow-700" ,
                2: "from-[#e6e6f0] to-[#d4d4e7] border-[#a0b3c9]" , 
                3: "from-[#edecec] to-[#e1e1e1] border-gray-400" ,
                4: "from-[#d1b3e0] to-[#b48bc9] border-purple-700" , 
                5: "from-[#f8c2d4] to-[#e68ca8] border-rose-700" ,
                6: "from-[#fff9d6] to-[#ffe680] border-yellow-500" }; %>
            <div class="flex flex-wrap justify-center gap-3 md:gap-8">
            <% cartes.forEach(carte=> { %>
            <%- include('partials/carte', { carte, gradientMap, color1, rarityLetters }) %>
            <% }) %>
            </div>
            <%- include('partials/modal-carte') %>
    </main>
    <%- include('partials/footer') %>

    <script>
        function ouvrirGestionCarte(id, nom, nbT0, nbT1, nbT2, nbT3, nbT4, imageUrl) {
          document.getElementById('carte-id-transform').value = id;
          document.getElementById('modal-carte').classList.remove('hidden');
          document.getElementById('modal-nom').innerText = nom;
          document.querySelector('#preview-image img').src = imageUrl;
        
          document.getElementById('count-T0').innerText = nbT0;
          document.getElementById('count-T1').innerText = nbT1;
          document.getElementById('count-T2').innerText = nbT2;
          document.getElementById('count-T3').innerText = nbT3;
          document.getElementById('count-T4').innerText = nbT4;
        
          // Enregistrer les donn√©es pour calculs
          window._carteEnCours = { id, nbT0, nbT1, nbT2, nbT3, nbT4 };
        
          // R√©initialiser la s√©lection
          document.getElementById('tier-cible').value = 'T1';
          document.getElementById('quantite-evolution').value = 1;
        
          updateEvolutionPossible();
        }

        function updateEvolutionPossible() {
        const tierCible = document.getElementById('tier-cible').value;
        const data = window._carteEnCours;

        const requirements = {
            T1: data.nbT0,
            T2: data.nbT1,
            T3: data.nbT2,
            T4: data.nbT3
        };

        const disponibles = requirements[tierCible];
        const max = Math.floor(disponibles / 5);

        document.getElementById('evolution-possible').innerText = `Max : ${max} transformation(s) possibles`;
        }

        function fermerModal() {
        document.getElementById('modal-carte').classList.add('hidden');
        document.body.style.overflow = '';
        }

        // Clique en dehors du contenu = fermer
        function fermerSiClicExterieur(event) {
        const modal = document.getElementById('modal-carte');
        const contenu = modal.querySelector('.max-w-5xl');

        if (!contenu.contains(event.target)) {
            fermerModal();
        }
        }

        document.addEventListener('keydown', function(event) {
  const modal = document.getElementById('modal-carte');
  if (event.key === 'Escape' && !modal.classList.contains('hidden')) {
    fermerModal();
  }
});

function lancerTransformation() {
  const carteId = document.getElementById('carte-id-transform').value;
  const tier = document.getElementById('tier-cible').value;
  const quantite = parseInt(document.getElementById('quantite-evolution').value);

  if (!quantite || quantite < 1) {
    afficherMessage("‚ùå Veuillez saisir une quantit√© valide.", false);
    return;
  }

  fetch('/transformer-en-tier', {
    method: 'POST',
    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
    body: `carte_id=${carteId}&tier=${tier}&quantite=${quantite}`
  })
  .then(response => {
    if (response.ok) {
      afficherMessage(`‚ú® ${quantite} transformation(s) vers ${tier} r√©ussie(s) !`, true);
    } else {
      response.text().then(msg => {
        afficherMessage(`‚ùå ${msg}`, false);
      });
    }
  })
  .catch(error => {
    console.error('Erreur r√©seau :', error);
    afficherMessage('‚ùå Erreur de connexion.', false);
  });
}

function afficherMessage(message, succes) {
  const msgDiv = document.createElement("div");
  msgDiv.className = `fixed top-10 left-1/2 transform -translate-x-1/2 px-6 py-4 rounded-lg shadow-lg z-50 ${
    succes ? "bg-green-100 text-green-800" : "bg-red-100 text-red-800"
  }`;
  msgDiv.innerText = message;

  document.body.appendChild(msgDiv);

  setTimeout(() => {
    msgDiv.remove();
    location.reload(); // Recharge pour mettre √† jour la collection
  }, 800);
}

function ouvrirVente() {
  document.getElementById('bloc-vente').classList.remove('hidden');
}

function vendreCarte() {
  const carteId = document.getElementById('carte-id-transform').value;
  const type = document.getElementById('tier-vente').value;
  const quantite = parseInt(document.getElementById('quantite-vente').value);

  if (!quantite || quantite < 1) {
    afficherMessage("‚ùå Quantit√© invalide", false);
    return;
  }

  fetch('/vendre-direct', {
    method: 'POST',
    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
    body: `carte_id=${carteId}&type=${type}&quantite=${quantite}`
  })
  .then(response => {
    if (response.ok) {
      afficherMessage("üí∏ Vente r√©ussie !", true);
    } else {
      response.text().then(msg => {
        afficherMessage(`‚ùå ${msg}`, false);
      });
    }
  })
  .catch(() => {
    afficherMessage("‚ùå Erreur r√©seau", false);
  });
}

function mettreEnVente() {
  const carteId = document.getElementById('carte-id-transform').value;
  const type = document.getElementById('tier-marche').value;
  const quantite = parseInt(document.getElementById('quantite-marche').value);
  const prix = parseInt(document.getElementById('prix-marche').value);

  if (!quantite || quantite < 1 || !prix || prix < 1) {
    afficherMessage("‚ùå Donn√©es invalides", false);
    return;
  }

  fetch('/mettre-en-vente', {
    method: 'POST',
    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
    body: `carte_id=${carteId}&type=${type}&quantite=${quantite}&prix=${prix}`
  })
  .then(response => {
    if (response.ok) {
      afficherMessage("üõí Carte en vente au march√© !", true);
    } else {
      response.text().then(msg => {
        afficherMessage(`‚ùå ${msg}`, false);
      });
    }
  })
  .catch(() => {
    afficherMessage("‚ùå Erreur r√©seau", false);
  });
}

function choisirVente(type) {
  document.getElementById('vente-directe').classList.add('hidden');
  document.getElementById('vente-marche').classList.add('hidden');

  if (type === 'direct') {
    document.getElementById('vente-directe').classList.remove('hidden');
  } else if (type === 'marche') {
    document.getElementById('vente-marche').classList.remove('hidden');
  }
}


        </script>
        
</body>

</html>