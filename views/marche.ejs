<!DOCTYPE html>
<html lang="fr" class="font-grotesque bg-mint-green-100">
<head>
  <meta charset="UTF-8">
  <title>Marché</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Darker+Grotesque:wght@300..900&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/css/output.css">
  <link rel="stylesheet" href="/style-cards.css">
</head>
<body class="bg-gray-100 min-h-screen mb-10">
  <%- include('partials/cartes-vars') %>
  <!-- HEADER -->
  <%- include('partials/header') %>

  <main class="min-h-screen bg-gray-50 px-2 py-6">
    <div class="button-principal">
      <div><a href="/" class="text-sm">Accueil</a></div>
    </div>
    <h1 class="text-3xl font-bold text-center mb-8">🛒 Marché des cartes</h1>
  
    <% if (success === 'ok') { %>
      <div class="bg-green-100 text-green-800 p-4 rounded mb-6 text-center">Achat réussi !</div>
    <% } else if (success === 'notenough') { %>
      <div class="bg-red-100 text-red-800 p-4 rounded mb-6 text-center">Pas assez de jetons.</div>
    <% } else if (success === 'error') { %>
      <div class="bg-red-100 text-red-800 p-4 rounded mb-6 text-center">Erreur lors de la transaction.</div>
    <% } else if (success === 'invalid') { %>
      <div class="bg-red-100 text-red-800 p-4 rounded mb-6 text-center">Produit invalide.</div>
    <% } if (success === 'cancelled') { %>
      <div class="bg-yellow-100 text-yellow-800 p-4 rounded mb-6 text-center">Vente annulée.</div>
    <% } %>

        <%
    const tierLabels = {
      nb_exemplaires: "Tier 0",
      nb_brillante: "Tier 1",
      nb_alternative: "Tier 2",
      nb_noir_blanc: "Tier 3",
      nb_gold: "Tier 4"
    };
    %>

    <% const gradientMap={ 
      1: "from-[#e8d8c3] to-[#dab892] border-yellow-700" ,
      2: "from-[#e6e6f0] to-[#d4d4e7] border-[#a0b3c9]" , 
      3: "from-[#edecec] to-[#e1e1e1] border-gray-400" ,
      4: "from-[#d1b3e0] to-[#b48bc9] border-purple-700" , 
      5: "from-[#f8c2d4] to-[#e68ca8] border-rose-700" ,
      6: "from-[#fff9d6] to-[#ffe680] border-yellow-500" }; %>
  
  <div class="flex flex-wrap justify-center gap-3 md:gap-8">
  <% ventes.forEach(carte => { %>
    <div class="flex flex-col items-center border rounded border-gray-300 p-6 shadow-2xl">
      <%- include('partials/carte', { carte, gradientMap, color1, rarityLetters }) %>
      <div class="m-4">
        <div class="text-sm text-gray-600 mt-1">Tier : <%= tierLabels[carte.type] || "Inconnue" %></div>
        <div class="text-sm text-gray-600">Rareté : <%= rarityLetters[carte.rarete] %></div>
        <div class="text-sm text-gray-600">Vendeur : <%= carte.vendeur %></div>
        <div class="text-sm text-gray-800">Quantité : <%= carte.quantite %></div>
        <div class="text-xl font-bold text-green-700 mt-2">💰 <%= carte.prix_par_unite %> jetons</div>

        <% if (carte.vendeur === utilisateur.pseudo) { %>
          <form method="POST" action="/annuler-vente" class="w-full mt-2">
            <input type="hidden" name="vente_id" value="<%= carte.vente_id %>" />
            <button type="submit" class="bg-red-600 hover:bg-red-700 text-white font-bold w-full p-2 rounded">
              ❌ Annuler la vente
            </button>
          </form>
        <% } else { %>
          <form method="POST" action="/acheter" class="w-full mt-2">
            <input type="hidden" name="vente_id" value="<%= carte.vente_id %>" />
            <button type="submit" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold w-full p-2 rounded">
              Acheter
            </button>
          </form>
        <% } %>
      </div>
    </div>
  <% }) %>
</div>

  </main>
  
  <%- include('partials/footer') %>
</body>
</html>
